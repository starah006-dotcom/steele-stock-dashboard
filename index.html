<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Dashboard - Steele Family</title>
  <!-- Build: 2026-01-31-v7-dividends-competitors-industries -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f0f23; color: #e0e0e0; min-height: 100vh; }
    .header { background: linear-gradient(135deg, #1a1a3e 0%, #0f0f23 100%); padding: 20px 30px; border-bottom: 1px solid #2a2a4a; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .header h1 { font-size: 24px; font-weight: 600; color: #fff; }
    .header .subtitle { color: #888; font-size: 14px; margin-top: 4px; }
    .last-updated { color: #666; font-size: 12px; }
    .tabs { display: flex; gap: 4px; padding: 12px 30px; background: #12122a; border-bottom: 1px solid #2a2a4a; overflow-x: auto; }
    .tab { padding: 8px 14px; background: transparent; border: 1px solid #3a3a5a; border-radius: 8px; color: #888; cursor: pointer; white-space: nowrap; font-size: 12px; transition: all 0.2s; }
    .tab:hover { background: #1a1a3e; color: #fff; }
    .tab.active { background: #2563eb; border-color: #2563eb; color: #fff; }
    .tab.parent { border-color: #f59e0b44; }
    .tab.parent.active { background: #f59e0b; border-color: #f59e0b; }
    .main { padding: 30px; max-width: 1600px; margin: 0 auto; }

    /* Portfolio Summary */
    .portfolio-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .summary-card { background: #1a1a3e; border-radius: 12px; padding: 18px; border: 1px solid #2a2a4a; }
    .summary-card .label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 6px; }
    .summary-card .value { font-size: 26px; font-weight: 700; color: #fff; }
    .summary-card .value.up { color: #10b981; }
    .summary-card .value.down { color: #ef4444; }
    .summary-card .sub { font-size: 12px; color: #888; margin-top: 4px; }
    .summary-card .sub.up { color: #10b981; }
    .summary-card .sub.down { color: #ef4444; }

    /* Holdings Table */
    .holdings-card { background: #1a1a3e; border-radius: 12px; border: 1px solid #2a2a4a; overflow: hidden; margin-bottom: 24px; }
    .holdings-card h3 { font-size: 14px; padding: 16px 20px; border-bottom: 1px solid #2a2a4a; color: #fff; display: flex; align-items: center; gap: 8px; justify-content: space-between; }
    .sort-hint { font-size: 11px; color: #666; font-weight: normal; }
    .holdings-table { width: 100%; border-collapse: collapse; }
    .holdings-table th { text-align: left; padding: 12px 12px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: #666; border-bottom: 1px solid #2a2a4a; background: #12122a; cursor: pointer; user-select: none; white-space: nowrap; }
    .holdings-table th:hover { color: #fff; background: #1a1a3e; }
    .holdings-table th.sorted { color: #60a5fa; }
    .holdings-table th.sorted::after { content: ' ‚ñº'; font-size: 8px; }
    .holdings-table th.sorted.asc::after { content: ' ‚ñ≤'; }
    .holdings-table th.right, .holdings-table td.right { text-align: right; }
    .holdings-table td { padding: 12px 12px; border-bottom: 1px solid #2a2a4a22; font-size: 13px; }
    .holdings-table tr:hover { background: #12122a; }
    .holdings-table tr:last-child td { border-bottom: none; }
    .holdings-table .symbol { font-weight: 600; color: #fff; font-size: 14px; }
    .holdings-table .company { font-size: 10px; color: #666; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .holdings-table .up { color: #10b981; }
    .holdings-table .down { color: #ef4444; }
    .holdings-table .muted { color: #666; }
    .holdings-table .warning { color: #f59e0b; }
    .holdings-table .soon { background: #f59e0b22; padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #f59e0b; }

    /* AI Summary Card */
    .ai-summary-card { background: linear-gradient(135deg, #1a1a3e 0%, #12122a 100%); border-radius: 12px; border: 1px solid #3b82f6; margin-bottom: 24px; overflow: hidden; }
    .ai-summary-card h3 { font-size: 14px; padding: 16px 20px; border-bottom: 1px solid #2a2a4a; color: #fff; display: flex; align-items: center; gap: 8px; background: #1e3a5f22; }
    .ai-summary-card h3 .icon { font-size: 18px; }
    .ai-summary-content { padding: 20px; font-size: 14px; line-height: 1.6; color: #c0c0c0; }
    .ai-summary-content .stock-insight { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #2a2a4a; }
    .ai-summary-content .stock-insight:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }
    .ai-summary-content .stock-ticker { font-weight: 600; color: #60a5fa; margin-right: 8px; }
    .ai-summary-content .bullish { color: #10b981; }
    .ai-summary-content .bearish { color: #ef4444; }
    .ai-summary-content .neutral { color: #888; }
    .ai-loading { text-align: center; padding: 40px; color: #666; }
    .ai-loading .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    
    /* Skeleton loading styles */
    .skeleton { background: linear-gradient(90deg, #1a1a3e 25%, #2a2a4a 50%, #1a1a3e 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
    .skeleton-card { background: #1a1a3e; border-radius: 12px; padding: 18px; border: 1px solid #2a2a4a; }
    .skeleton-text { height: 14px; margin-bottom: 8px; }
    .skeleton-text.lg { height: 26px; width: 60%; }
    .skeleton-text.sm { height: 12px; width: 40%; }
    .skeleton-row { display: flex; gap: 12px; padding: 12px; border-bottom: 1px solid #2a2a4a22; }
    .skeleton-row > div { flex: 1; }
    .skeleton-cell { height: 16px; }

    /* Stock Detail Modal */
    .stock-detail { display: none; }
    .stock-detail.active { display: block; }
    .back-btn { background: #2a2a4a; border: none; color: #888; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-bottom: 20px; }
    .back-btn:hover { background: #3a3a5a; color: #fff; }

    .stock-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; flex-wrap: wrap; gap: 20px; }
    .stock-info h2 { font-size: 28px; color: #fff; }
    .stock-info .company-name { color: #888; font-size: 14px; margin-top: 4px; }
    .price-box { text-align: right; }
    .price { font-size: 42px; font-weight: 700; }
    .price.up { color: #10b981; }
    .price.down { color: #ef4444; }
    .price-change { font-size: 16px; margin-top: 4px; }
    .price-change.up { color: #10b981; }
    .price-change.down { color: #ef4444; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .card { background: #1a1a3e; border-radius: 12px; padding: 20px; border: 1px solid #2a2a4a; }
    .card h3 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
    .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .stat-item label { font-size: 11px; color: #666; display: block; margin-bottom: 2px; }
    .stat-item .value { font-size: 18px; font-weight: 600; color: #fff; }
    .stat-item .value.highlight { color: #10b981; }
    .stat-item .value.warning { color: #f59e0b; }

    .news-list { display: flex; flex-direction: column; gap: 10px; max-height: 280px; overflow-y: auto; }
    .news-item { padding-bottom: 10px; border-bottom: 1px solid #2a2a4a; }
    .news-item:last-child { border-bottom: none; }
    .news-item .date { font-size: 10px; color: #666; margin-bottom: 3px; }
    .news-item .title { font-size: 13px; color: #fff; line-height: 1.4; text-decoration: none; display: block; }
    .news-item .title:hover { color: #60a5fa; }
    .news-item.bearish .title { color: #ef4444; }
    .news-item.bullish .title { color: #10b981; }
    .tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600; margin-left: 6px; }
    .tag.new { background: #10b98122; color: #10b981; }
    .tag.transcript { background: #7c3aed22; color: #a78bfa; }
    .tag.bearish { background: #ef444422; color: #ef4444; }
    .tag.bullish { background: #10b98122; color: #10b981; }

    /* SEC Filings */
    .filings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
    .filing-card { background: #12122a; border: 1px solid #2a2a4a; border-radius: 8px; padding: 12px; transition: all 0.2s; }
    .filing-card:hover { border-color: #3b82f6; background: #1a1a3e; }
    .filing-card .form-type { font-weight: 600; color: #fff; font-size: 14px; margin-bottom: 4px; }
    .filing-card .form-type.annual { color: #10b981; }
    .filing-card .form-type.quarterly { color: #60a5fa; }
    .filing-card .form-type.current { color: #f59e0b; }
    .filing-card .filed-date { font-size: 11px; color: #666; margin-bottom: 8px; }
    .filing-card .filing-links { display: flex; gap: 8px; }
    .filing-card .filing-links a { font-size: 11px; color: #60a5fa; text-decoration: none; padding: 4px 8px; background: #1a1a3e; border-radius: 4px; }
    .filing-card .filing-links a:hover { background: #2a2a5a; }
    .summarize-btn { background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); border: none; color: #fff; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; }
    .summarize-btn:hover { opacity: 0.9; }

    .clickable { cursor: pointer; }
    .member-label { font-size: 11px; color: #666; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
    .empty-state { text-align: center; padding: 60px 20px; color: #666; }
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; }

    /* Powered by badge */
    .powered-by { font-size: 10px; font-weight: normal; color: #666; margin-left: auto; }

    /* Alerts Row */
    .alerts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .alert-card { background: #1a1a3e; border-radius: 12px; padding: 16px; border: 1px solid #2a2a4a; display: flex; align-items: center; gap: 14px; }
    .alert-card.earnings-alert { border-left: 3px solid #f59e0b; }
    .alert-card.concentration-alert { border-left: 3px solid #ef4444; }
    .alert-card.dividend-alert { border-left: 3px solid #10b981; }
    .alert-icon { font-size: 24px; }
    .alert-content { flex: 1; }
    .alert-title { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #888; margin-bottom: 4px; }
    .alert-detail { font-size: 14px; color: #fff; font-weight: 500; }
    .alert-detail .warning { color: #f59e0b; }
    .alert-detail .danger { color: #ef4444; }
    .alert-detail .success { color: #10b981; }

    /* Research Card */
    .research-card { border-color: #8b5cf6; }
    .research-card h3 { display: flex; justify-content: space-between; align-items: center; }
    .research-btn { background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); border: none; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; }
    .research-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4); }
    .research-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .research-btn.loading .research-btn-text::before { content: ''; display: inline-block; width: 12px; height: 12px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; vertical-align: middle; }
    .research-content { padding: 20px 0 0 0; font-size: 14px; line-height: 1.7; color: #c0c0c0; }
    .research-content h4 { color: #8b5cf6; font-size: 13px; margin: 16px 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px; }
    .research-content h4:first-child { margin-top: 0; }
    .research-content ul { margin: 8px 0; padding-left: 20px; }
    .research-content li { margin: 4px 0; }
    .research-content strong { color: #fff; }
    .research-content .bullish { color: #10b981; }
    .research-content .bearish { color: #ef4444; }

    /* Competitors Table */
    .competitors-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .competitors-table th { text-align: left; padding: 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: #666; border-bottom: 1px solid #2a2a4a; }
    .competitors-table td { padding: 10px 8px; border-bottom: 1px solid #2a2a4a22; font-size: 12px; }
    .competitors-table tr:hover { background: #12122a; }
    .competitors-table .symbol { font-weight: 600; color: #fff; }
    .competitors-table .target-row { background: #10b98115; }
    .competitors-table .target-row .symbol { color: #10b981; }
    .competitors-table .up { color: #10b981; }
    .competitors-table .down { color: #ef4444; }
    .competitors-table .right { text-align: right; }
    
    /* Industry comparison button in tabs */
    .tab.industry-btn { background: #10b98122; border-color: #10b981; color: #10b981; }
    .tab.industry-btn:hover { background: #10b981; color: #fff; }

    @media (max-width: 900px) {
      .main { padding: 15px; }
      .tabs { padding: 10px 15px; }
      .holdings-table { font-size: 11px; }
      .holdings-table th, .holdings-table td { padding: 8px 6px; }
      .summary-card .value { font-size: 20px; }
      .hide-mobile { display: none; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>üìä Steele Family Portfolio</h1>
      <div class="subtitle">Real-time Yahoo Finance + Seeking Alpha + AI Analysis</div>
    </div>
    <div class="last-updated">
      Updated: <span id="update-time">--</span>
      <button onclick="loadPortfolio()" style="margin-left:12px;padding:6px 12px;background:#2563eb;border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:12px;">üîÑ Refresh</button>
    </div>
  </div>

  <div class="tabs" id="tabs"></div>

  <div class="main">
    <div class="member-label" id="member-label">PORTFOLIO</div>

    <!-- Portfolio View -->
    <div id="portfolio-view">
      <div class="portfolio-summary" id="portfolio-summary"></div>

      <!-- AI Market Scan Summary -->
      <div class="ai-summary-card" id="ai-summary-card" style="display:none;">
        <h3><span class="icon">ü§ñ</span> AI Market Scan <span class="powered-by">Powered by Claude</span></h3>
        <div class="ai-summary-content" id="ai-summary-content">
          <div class="ai-loading"><span class="spinner"></span>Analyzing your holdings...</div>
        </div>
      </div>

      <!-- Earnings Calendar & Alerts -->
      <div class="alerts-row" id="alerts-row" style="display:none;">
        <div class="alert-card earnings-alert" id="earnings-alert">
          <div class="alert-icon">üìÖ</div>
          <div class="alert-content">
            <div class="alert-title">Upcoming Earnings</div>
            <div class="alert-detail" id="earnings-detail">--</div>
          </div>
        </div>
        <div class="alert-card concentration-alert" id="concentration-alert">
          <div class="alert-icon">‚öñÔ∏è</div>
          <div class="alert-content">
            <div class="alert-title">Concentration Risk</div>
            <div class="alert-detail" id="concentration-detail">--</div>
          </div>
        </div>
        <div class="alert-card dividend-alert" id="dividend-alert">
          <div class="alert-icon">üí∞</div>
          <div class="alert-content">
            <div class="alert-title">Next Dividend</div>
            <div class="alert-detail" id="dividend-detail">--</div>
          </div>
        </div>
      </div>

      <div class="holdings-card">
        <h3>
          <span>üíº Holdings</span>
          <span class="sort-hint">Click column headers to sort</span>
        </h3>
        <div style="overflow-x: auto;">
        <table class="holdings-table">
          <thead>
            <tr>
              <th data-sort="symbol">Symbol</th>
              <th class="right" data-sort="price">Price</th>
              <th class="right" data-sort="change">Day Chg</th>
              <th class="right" data-sort="value">Value</th>
              <th class="right" data-sort="gain">Gain/Loss</th>
              <th class="right" data-sort="gainPct">Gain %</th>
              <th class="right" data-sort="yield">Yield</th>
              <th class="right hide-mobile" data-sort="exDiv">Ex-Div</th>
              <th class="right hide-mobile" data-sort="annualDiv">Annual Div</th>
            </tr>
          </thead>
          <tbody id="holdings-body"></tbody>
        </table>
        </div>
      </div>
    </div>

    <!-- Stock Detail View -->
    <div id="stock-detail" class="stock-detail">
      <button class="back-btn" onclick="showPortfolio()">‚Üê Back to Portfolio</button>
      <div class="stock-header">
        <div class="stock-info">
          <h2 id="detail-stock-name">Loading...</h2>
          <div class="company-name" id="detail-company-name">--</div>
        </div>
        <div class="price-box">
          <div class="price" id="detail-stock-price">--</div>
          <div class="price-change" id="detail-price-change">--</div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h3><span class="icon">üí∞</span> Position & Dividend</h3>
          <div class="stat-grid" id="detail-position"></div>
        </div>
        <div class="card">
          <h3><span class="icon">üìà</span> Key Stats</h3>
          <div class="stat-grid" id="detail-stats"></div>
        </div>
        <div class="card">
          <h3><span class="icon">üìã</span> Press Releases</h3>
          <div class="news-list" id="detail-press"><div style="color:#666">Loading...</div></div>
        </div>
        <div class="card">
          <h3><span class="icon">üéôÔ∏è</span> Earnings Calls</h3>
          <div class="news-list" id="detail-transcripts"><div style="color:#666">Loading...</div></div>
        </div>
        <div class="card" style="grid-column: span 2;">
          <h3><span class="icon">üì∞</span> Analysis <span style="font-weight:normal;color:#666;font-size:10px;margin-left:8px">(üî¥ bearish ¬∑ üü¢ bullish)</span></h3>
          <div class="news-list" id="detail-articles"><div style="color:#666">Loading...</div></div>
        </div>
      </div>

      <!-- SEC Filings Section -->
      <div class="card" style="margin-top: 20px;">
        <h3>
          <span><span class="icon">üìÅ</span> SEC Filings</span>
          <a id="ir-link" href="#" target="_blank" style="font-size:11px;color:#60a5fa;text-decoration:none;margin-left:auto;">Investor Relations ‚Üí</a>
        </h3>
        <div class="filings-grid" id="detail-filings">
          <div style="color:#666">Loading...</div>
        </div>
      </div>
      
      <!-- Social Sentiment Section -->
      <div class="card" style="margin-top: 20px;">
        <h3>
          <span><span class="icon">üìä</span> Social Sentiment</span>
          <button class="research-btn" id="sentiment-btn" onclick="loadSocialSentiment()" style="font-size:11px;padding:4px 10px;">
            Analyze Sentiment
          </button>
        </h3>
        <div id="social-sentiment">
          <div style="color:#666;text-align:center;padding:10px;">Click to analyze social sentiment from credible financial sources</div>
        </div>
      </div>

      <!-- Competitors Section -->
      <div class="card" style="margin-top: 20px; border-color: #10b981;">
        <h3>
          <span><span class="icon">‚öîÔ∏è</span> Competitors</span>
          <span id="competitor-sector" style="font-size:11px;color:#10b981;margin-left:auto;font-weight:normal;">--</span>
        </h3>
        <div id="competitors-content">
          <div style="color:#666;text-align:center;padding:20px;">Loading competitors...</div>
        </div>
      </div>

      <!-- Deep Research Section -->
      <div class="card research-card" style="margin-top: 20px;">
        <h3>
          <span><span class="icon">üî¨</span> Deep Research</span>
          <button class="research-btn" id="research-btn" onclick="loadDeepResearch()">
            <span class="research-btn-text">Run Perplexity Research</span>
          </button>
        </h3>
        <div id="research-content" class="research-content">
          <div style="color:#666;text-align:center;padding:20px;">Click the button above to fetch real-time research from Perplexity AI</div>
        </div>
      </div>
    </div>

    <!-- Industry Comparison View -->
    <div id="industry-view" style="display:none;">
      <button class="back-btn" onclick="showPortfolio()">‚Üê Back to Portfolio</button>
      <h2 style="color:#fff;margin-bottom:20px;display:flex;align-items:center;gap:12px;">
        <span class="icon">üè≠</span>
        <span id="industry-title">Industry Comparison</span>
      </h2>
      <div class="holdings-card">
        <h3>
          <span id="industry-subtitle">Select an industry to compare</span>
          <select id="industry-select" onchange="loadIndustryComparison(this.value)" style="margin-left:auto;padding:6px 12px;background:#12122a;border:1px solid #3a3a5a;border-radius:6px;color:#fff;font-size:12px;">
            <option value="">-- Select Industry --</option>
          </select>
        </h3>
        <div style="overflow-x: auto;">
          <table class="holdings-table" id="industry-table">
            <thead>
              <tr>
                <th>Symbol</th>
                <th class="right">Price</th>
                <th class="right">Day Chg</th>
                <th class="right">Mkt Cap</th>
                <th class="right">P/E</th>
                <th class="right">Yield</th>
                <th class="right">YTD</th>
                <th class="right">52W Range</th>
              </tr>
            </thead>
            <tbody id="industry-body">
              <tr><td colspan="8" style="text-align:center;color:#666;padding:40px;">Select an industry above to compare stocks</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Portfolio data - shares and cost basis per share
    const PORTFOLIOS = {
      star: {
        name: 'Star',
        icon: '‚≠ê',
        holdings: [
          { symbol: 'NVDA', shares: 700, costBasis: 5.1503 },
          { symbol: 'AMZN', shares: 350, costBasis: 154.6477 },
          { symbol: 'META', shares: 165, costBasis: 194.86 },  // 130@217.21 + 35@111.84
          { symbol: 'PLTR', shares: 490, costBasis: 15.9482 },
          { symbol: 'ET', shares: 4500, costBasis: 6.1146 },
          { symbol: 'AAPL', shares: 400, costBasis: 34.72 },   // 200@41.21 + 200@28.22
          { symbol: 'GOOGL', shares: 362, costBasis: 147.07 }, // 125@98.64 + 237@172.60
          { symbol: 'ARKB', shares: 2195, costBasis: 16.67 },  // 1157@15.58 + 1038@17.88
          { symbol: 'TSLA', shares: 119, costBasis: 301.0092 },
          { symbol: 'JPM', shares: 100, costBasis: 99.2174 },
          { symbol: 'BLOK', shares: 159, costBasis: 62.9177 },
          { symbol: 'DELL', shares: 108, costBasis: 125.02 },  // 51@125.04 + 57@125.00
          { symbol: 'THNQ', shares: 299, costBasis: 52.4067 },
          { symbol: 'BTO', shares: 315, costBasis: 24.3786 },
          { symbol: 'XOVR', shares: 549, costBasis: 17.3108 },
          { symbol: 'AGNC', shares: 199, costBasis: 10.1993 }
        ],
        cash: 206.95
      },
      peter: { name: 'Peter', icon: 'üë®‚Äçüíº', parent: true, holdings: [], cash: 0 },
      sherry: { name: 'Sherry', icon: 'üë©‚Äçüíº', parent: true, holdings: [], cash: 0 },
      sky: { name: 'Sky', icon: 'üåü', holdings: [], cash: 0 },
      jet: { name: 'Jet', icon: '‚úàÔ∏è', holdings: [], cash: 0 },
      everly: { name: 'Everly', icon: 'üéÄ', holdings: [], cash: 0 },
      leo: { name: 'Leo', icon: 'ü¶Å', holdings: [], cash: 0 },
      autumn: { name: 'Autumn', icon: 'üçÇ', holdings: [], cash: 0 },
      ace: { name: 'Ace', icon: 'üÉè', holdings: [], cash: 0 },
      stryker: { name: 'Stryker', icon: '‚ö°', holdings: [], cash: 0 },
      maverick: { name: 'Maverick', icon: 'üî•', holdings: [], cash: 0 },
      cannon: { name: 'Cannon', icon: 'üí•', holdings: [], cash: 0 },
      missile: { name: 'Missile', icon: 'üöÄ', holdings: [], cash: 0 }
    };

    let currentMember = 'star';
    let stockCache = {};
    let currentStockData = [];
    let currentSort = { key: 'value', asc: false };
    let currentDetailSymbol = null;

    // Bearish keywords for article sentiment
    const BEARISH_KEYWORDS = ['sell', 'downgrade', 'bear', 'decline', 'risk', 'warning', 'concern', 'trouble', 'weak', 'drop', 'fall', 'crash', 'overvalued', 'avoid', 'cut', 'negative', 'miss', 'disappoint', 'struggle', 'headwind'];
    const BULLISH_KEYWORDS = ['buy', 'upgrade', 'bull', 'growth', 'strong', 'beat', 'outperform', 'opportunity', 'undervalued', 'momentum', 'surge', 'rally', 'positive', 'exceed', 'impressive', 'tailwind', 'breakout'];

    function detectSentiment(title) {
      const lower = title.toLowerCase();
      const bearishScore = BEARISH_KEYWORDS.filter(w => lower.includes(w)).length;
      const bullishScore = BULLISH_KEYWORDS.filter(w => lower.includes(w)).length;
      if (bearishScore > bullishScore) return 'bearish';
      if (bullishScore > bearishScore) return 'bullish';
      return 'neutral';
    }

    function formatMoney(n) {
      if (n === undefined || n === null || isNaN(n)) return '--';
      return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatCompact(n) {
      if (n === undefined || n === null || isNaN(n)) return '--';
      if (Math.abs(n) >= 1000) return '$' + (n/1000).toFixed(1) + 'K';
      return '$' + n.toFixed(0);
    }

    function formatPercent(n) {
      if (n === undefined || n === null || isNaN(n)) return '--';
      return (n >= 0 ? '+' : '') + n.toFixed(2) + '%';
    }

    function timeAgo(dateStr) {
      if (!dateStr) return '--';
      const d = new Date(dateStr), now = new Date();
      const hrs = Math.floor((now - d) / 36e5);
      if (hrs < 1) return 'Just now';
      if (hrs < 24) return hrs + 'h ago';
      const days = Math.floor(hrs / 24);
      return days === 1 ? 'Yesterday' : days < 7 ? days + 'd ago' : d.toLocaleDateString('en-US', {month:'short',day:'numeric'});
    }

    function formatDate(dateStr) {
      if (!dateStr) return '--';
      return new Date(dateStr).toLocaleDateString('en-US', {month:'short',day:'numeric'});
    }

    function daysUntil(dateStr) {
      if (!dateStr) return null;
      const d = new Date(dateStr);
      const now = new Date();
      now.setHours(0,0,0,0);
      d.setHours(0,0,0,0);
      return Math.ceil((d - now) / (1000 * 60 * 60 * 24));
    }

    // Build tabs
    function buildTabs() {
      const tabsEl = document.getElementById('tabs');
      tabsEl.innerHTML = Object.entries(PORTFOLIOS).map(([key, p]) =>
        `<div class="tab ${p.parent ? 'parent' : ''} ${key === currentMember ? 'active' : ''}" data-member="${key}">${p.icon} ${p.name}</div>`
      ).join('') + `<div class="tab industry-btn" data-action="industry">üè≠ Industry Compare</div>`;

      tabsEl.querySelectorAll('.tab[data-member]').forEach(t => t.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        currentMember = t.dataset.member;
        loadPortfolio();
      }));
      
      // Industry compare button
      tabsEl.querySelector('.tab[data-action="industry"]').addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        tabsEl.querySelector('.tab[data-action="industry"]').classList.add('active');
        showIndustryView();
      });
    }
    
    async function showIndustryView() {
      document.getElementById('portfolio-view').style.display = 'none';
      document.getElementById('stock-detail').classList.remove('active');
      document.getElementById('industry-view').style.display = 'block';
      
      // Load industry options
      try {
        const res = await fetch('/api/competitors?list=industries');
        const data = await res.json();
        
        if (data.industries) {
          const select = document.getElementById('industry-select');
          select.innerHTML = '<option value="">-- Select Industry --</option>' + 
            data.industries.map(ind => `<option value="${ind}">${ind}</option>`).join('');
        }
      } catch (e) {
        console.error('Failed to load industries:', e);
      }
    }
    
    async function loadIndustryComparison(industry) {
      if (!industry) return;
      
      const tbody = document.getElementById('industry-body');
      const subtitle = document.getElementById('industry-subtitle');
      
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;"><span class="spinner" style="display:inline-block;width:16px;height:16px;border:2px solid #3b82f6;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-right:10px;vertical-align:middle;"></span>Loading industry data...</td></tr>';
      subtitle.textContent = industry;
      
      try {
        const res = await fetch(`/api/competitors?industry=${encodeURIComponent(industry)}`);
        const data = await res.json();
        
        if (data.error || !data.stocks?.length) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#ef4444;padding:30px;">Failed to load industry data</td></tr>';
          return;
        }
        
        // Sort by market cap descending
        const sorted = data.stocks.sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0));
        
        // Format helpers
        const fmt = (n, dec = 2) => n != null && !isNaN(n) ? n.toFixed(dec) : '--';
        const fmtMktCap = (n) => {
          if (!n || isNaN(n)) return '--';
          if (n >= 1e12) return '$' + (n/1e12).toFixed(1) + 'T';
          if (n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
          if (n >= 1e6) return '$' + (n/1e6).toFixed(0) + 'M';
          return '$' + n.toLocaleString();
        };
        
        tbody.innerHTML = sorted.map(s => {
          const isUp = (s.changePercent || 0) >= 0;
          const ytdUp = (s.ytdReturn || 0) >= 0;
          const inPortfolio = PORTFOLIOS[currentMember]?.holdings?.some(h => h.symbol === s.symbol);
          
          return `<tr ${inPortfolio ? 'style="background:#10b98115;"' : ''}>
            <td>
              <div class="symbol" ${inPortfolio ? 'style="color:#10b981;"' : ''}>${s.symbol}${inPortfolio ? ' ‚òÖ' : ''}</div>
              <div class="company">${s.name || ''}</div>
            </td>
            <td class="right">${s.price ? '$' + fmt(s.price) : '--'}</td>
            <td class="right ${isUp ? 'up' : 'down'}">${s.changePercent != null ? (isUp ? '+' : '') + fmt(s.changePercent) + '%' : '--'}</td>
            <td class="right">${fmtMktCap(s.marketCap)}</td>
            <td class="right">${fmt(s.pe, 1)}</td>
            <td class="right">${s.dividendYield ? fmt(s.dividendYield) + '%' : '--'}</td>
            <td class="right ${ytdUp ? 'up' : 'down'}">${s.ytdReturn != null ? (ytdUp ? '+' : '') + fmt(s.ytdReturn) + '%' : '--'}</td>
            <td class="right hide-mobile" style="font-size:11px;">$${fmt(s.week52Low, 0)} - $${fmt(s.week52High, 0)}</td>
          </tr>`;
        }).join('');
        
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#ef4444;padding:30px;">Error: ${err.message}</td></tr>`;
      }
    }

    // Sorting
    function setupSorting() {
      document.querySelectorAll('.holdings-table th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.dataset.sort;
          if (currentSort.key === key) {
            currentSort.asc = !currentSort.asc;
          } else {
            currentSort.key = key;
            currentSort.asc = false;
          }
          renderHoldings();
        });
      });
    }

    function sortData(data) {
      const key = currentSort.key;
      const asc = currentSort.asc;
      return [...data].sort((a, b) => {
        let valA = a[key], valB = b[key];
        if (key === 'symbol') {
          valA = valA || ''; valB = valB || '';
          return asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        }
        if (key === 'exDiv') {
          valA = a.exDivDays ?? 999; valB = b.exDivDays ?? 999;
        }
        valA = valA ?? -Infinity; valB = valB ?? -Infinity;
        return asc ? valA - valB : valB - valA;
      });
    }

    // Batch fetch multiple stocks in one request - much faster!
    async function batchFetchStocks(symbols) {
      const cacheAge = 30000; // 30s cache
      const uncached = symbols.filter(s => !stockCache[s] || (Date.now() - stockCache[s].fetchedAt) > cacheAge);
      
      if (uncached.length > 0) {
        try {
          const res = await fetch('/api/stocks?symbols=' + uncached.join(','), { credentials: 'same-origin' });
          const data = await res.json();
          if (data.stocks) {
            Object.entries(data.stocks).forEach(([symbol, stockData]) => {
              stockCache[symbol] = { data: stockData, fetchedAt: Date.now() };
            });
          }
        } catch (e) {
          console.error('Batch fetch failed, falling back to individual', e);
          await Promise.all(uncached.map(s => fetchStock(s)));
        }
      }
      
      return symbols.map(s => stockCache[s]?.data || {});
    }

    // Individual fetch for stock detail (includes Seeking Alpha data)
    async function fetchStock(symbol) {
      // 30s cache for basic data
      if (stockCache[symbol] && (Date.now() - stockCache[symbol].fetchedAt) < 30000) {
        return stockCache[symbol].data;
      }
      try {
        const res = await fetch('/api/stock/' + symbol, { credentials: 'same-origin' });
        const data = await res.json();
        stockCache[symbol] = { data, fetchedAt: Date.now() };
        return data;
      } catch (e) {
        console.error('Failed to fetch', symbol, e);
        return {};
      }
    }
    
    // Render skeleton loading UI
    function renderSkeletons(count) {
      // Summary skeleton
      document.getElementById('portfolio-summary').innerHTML = Array(5).fill(`
        <div class="skeleton-card">
          <div class="skeleton skeleton-text sm"></div>
          <div class="skeleton skeleton-text lg"></div>
          <div class="skeleton skeleton-text sm"></div>
        </div>
      `).join('');
      
      // Table skeleton
      document.getElementById('holdings-body').innerHTML = Array(count).fill(`
        <tr>
          <td><div class="skeleton skeleton-text" style="width:60px;height:16px;margin-bottom:4px"></div><div class="skeleton skeleton-text" style="width:100px;height:10px"></div></td>
          <td class="right"><div class="skeleton skeleton-text" style="width:50px;height:16px;margin-left:auto"></div></td>
          <td class="right"><div class="skeleton skeleton-text" style="width:40px;height:16px;margin-left:auto"></div></td>
          <td class="right"><div class="skeleton skeleton-text" style="width:50px;height:16px;margin-left:auto"></div></td>
          <td class="right"><div class="skeleton skeleton-text" style="width:50px;height:16px;margin-left:auto"></div></td>
          <td class="right"><div class="skeleton skeleton-text" style="width:40px;height:16px;margin-left:auto"></div></td>
          <td class="right"><div class="skeleton skeleton-text" style="width:35px;height:16px;margin-left:auto"></div></td>
          <td class="right hide-mobile"><div class="skeleton skeleton-text" style="width:45px;height:16px;margin-left:auto"></div></td>
          <td class="right hide-mobile"><div class="skeleton skeleton-text" style="width:45px;height:16px;margin-left:auto"></div></td>
        </tr>
      `).join('');
      
      // Alerts skeleton
      document.getElementById('alerts-row').style.display = 'grid';
      document.getElementById('earnings-detail').innerHTML = '<div class="skeleton skeleton-text" style="width:120px;height:14px"></div>';
      document.getElementById('concentration-detail').innerHTML = '<div class="skeleton skeleton-text" style="width:100px;height:14px"></div>';
      document.getElementById('dividend-detail').innerHTML = '<div class="skeleton skeleton-text" style="width:110px;height:14px"></div>';
    }

    function showPortfolio() {
      document.getElementById('portfolio-view').style.display = 'block';
      document.getElementById('stock-detail').classList.remove('active');
      document.getElementById('industry-view').style.display = 'none';
    }

    async function showStockDetail(symbol) {
      const member = PORTFOLIOS[currentMember];
      const holding = member.holdings.find(h => h.symbol === symbol);
      if (!holding) return;

      document.getElementById('portfolio-view').style.display = 'none';
      document.getElementById('stock-detail').classList.add('active');

      const d = await fetchStock(symbol);
      console.log('Stock detail data for', symbol, ':', {
        articles: d.articles?.length || 0,
        transcripts: d.transcripts?.length || 0,
        pressReleases: d.pressReleases?.length || 0,
        hasArticles: !!d.articles,
        fullData: d
      });
      const shares = holding.shares;
      const costBasis = holding.costBasis;
      const totalCost = shares * costBasis;
      const currentValue = shares * (d.price || 0);
      const gain = currentValue - totalCost;
      const gainPct = totalCost > 0 ? (gain / totalCost) * 100 : 0;

      const isUp = d.change >= 0;
      document.getElementById('detail-stock-name').textContent = symbol + ' - ' + (d.name || '');
      document.getElementById('detail-company-name').textContent = (d.exchange || '') + ' ¬∑ ' + shares.toLocaleString() + ' shares ¬∑ ' + (d.analystRating || '');
      document.getElementById('detail-stock-price').textContent = formatMoney(d.price);
      document.getElementById('detail-stock-price').className = 'price ' + (isUp ? 'up' : 'down');
      document.getElementById('detail-price-change').textContent = (isUp ? '+' : '') + (d.change?.toFixed(2) || '0') + ' (' + (d.changePercent?.toFixed(2) || '0') + '%)';
      document.getElementById('detail-price-change').className = 'price-change ' + (isUp ? 'up' : 'down');

      const qDiv = (d.dividendRate || 0) / 4;
      const qPay = qDiv * shares;
      const aPay = (d.dividendRate || 0) * shares;
      const exDivDays = daysUntil(d.exDividendDate);

      document.getElementById('detail-position').innerHTML =
        `<div class="stat-item"><label>Shares</label><div class="value">${shares.toLocaleString()}</div></div>` +
        `<div class="stat-item"><label>Cost Basis</label><div class="value">${formatMoney(costBasis)}</div></div>` +
        `<div class="stat-item"><label>Current Value</label><div class="value highlight">${formatMoney(currentValue)}</div></div>` +
        `<div class="stat-item"><label>Total Gain</label><div class="value ${gain >= 0 ? 'highlight' : 'warning'}">${formatMoney(gain)} (${formatPercent(gainPct)})</div></div>` +
        `<div class="stat-item"><label>Dividend Yield</label><div class="value">${(d.dividendYield?.toFixed(2) || '--')}%</div></div>` +
        `<div class="stat-item"><label>Annual Dividend</label><div class="value highlight">${formatMoney(aPay)}</div></div>` +
        `<div class="stat-item"><label>Ex-Dividend Date</label><div class="value ${exDivDays !== null && exDivDays <= 14 ? 'warning' : ''}">${formatDate(d.exDividendDate)}${exDivDays !== null && exDivDays >= 0 && exDivDays <= 14 ? ' ('+exDivDays+'d)' : ''}</div></div>` +
        `<div class="stat-item"><label>Pay Date</label><div class="value">${formatDate(d.dividendDate)}</div></div>`;

      document.getElementById('detail-stats').innerHTML =
        `<div class="stat-item"><label>Day Range</label><div class="value">${formatMoney(d.dayLow)} - ${formatMoney(d.dayHigh)}</div></div>` +
        `<div class="stat-item"><label>52W Range</label><div class="value">${formatMoney(d.fiftyTwoWeekLow)} - ${formatMoney(d.fiftyTwoWeekHigh)}</div></div>` +
        `<div class="stat-item"><label>Volume</label><div class="value">${((d.volume/1e6)?.toFixed(1)||'--')}M</div></div>` +
        `<div class="stat-item"><label>Market Cap</label><div class="value">$${((d.marketCap/1e9)?.toFixed(1)||'--')}B</div></div>` +
        `<div class="stat-item"><label>Next Earnings</label><div class="value warning">${formatDate(d.nextEarningsDate || d.earningsDate)}${d.earningsEstimate ? ' (Est: $'+d.earningsEstimate.toFixed(2)+')' : ''}</div></div>` +
        `<div class="stat-item"><label>P/E Ratio</label><div class="value">${d.trailingPE?.toFixed(1) || '--'}</div></div>`;

      // Render press releases
      try {
        if (d.pressReleases?.length) {
          document.getElementById('detail-press').innerHTML = d.pressReleases.map(p => {
            const isNew = (new Date() - new Date(p.attributes?.publishOn)) < 864e5;
            return `<div class="news-item"><div class="date">${timeAgo(p.attributes?.publishOn)}${isNew?'<span class="tag new">NEW</span>':''}</div><a class="title" href="${p.links?.self||'#'}" target="_blank">${p.attributes?.title||''}</a></div>`;
          }).join('');
        } else {
          document.getElementById('detail-press').innerHTML = '<div style="color:#666">No recent releases</div>';
        }
      } catch(e) { console.error('Press render error:', e); document.getElementById('detail-press').innerHTML = '<div style="color:#f00">Error: '+e.message+'</div>'; }

      // Render transcripts
      try {
        if (d.transcripts?.length) {
          document.getElementById('detail-transcripts').innerHTML = d.transcripts.map(t =>
            `<div class="news-item"><div class="date">${timeAgo(t.attributes?.publishOn)}<span class="tag transcript">CALL</span></div><a class="title" href="${t.links?.self||'#'}" target="_blank">${t.attributes?.title||''}</a></div>`
          ).join('');
        } else {
          document.getElementById('detail-transcripts').innerHTML = '<div style="color:#666">No recent calls</div>';
        }
      } catch(e) { console.error('Transcripts render error:', e); document.getElementById('detail-transcripts').innerHTML = '<div style="color:#f00">Error: '+e.message+'</div>'; }

      // Render articles
      try {
        if (d.articles?.length) {
          document.getElementById('detail-articles').innerHTML = d.articles.map(a => {
            const sentiment = detectSentiment(a.attributes?.title || '');
            const sentimentClass = sentiment !== 'neutral' ? sentiment : '';
            const sentimentTag = sentiment !== 'neutral' ? `<span class="tag ${sentiment}">${sentiment.toUpperCase()}</span>` : '';
            return `<div class="news-item ${sentimentClass}"><div class="date">${timeAgo(a.attributes?.publishOn)}${sentimentTag}</div><a class="title" href="${a.links?.self||'#'}" target="_blank">${a.attributes?.title||''}</a></div>`;
          }).join('');
        } else {
          document.getElementById('detail-articles').innerHTML = '<div style="color:#666">No recent analysis</div>';
        }
      } catch(e) { console.error('Articles render error:', e); document.getElementById('detail-articles').innerHTML = '<div style="color:#f00">Error: '+e.message+'</div>'; }

      // Render SEC Filings - organized by type
      try {
        // Set IR link
        if (d.weburl) {
          document.getElementById('ir-link').href = d.weburl + '/investor-relations';
          document.getElementById('ir-link').style.display = 'inline';
        } else {
          document.getElementById('ir-link').style.display = 'none';
        }
        
        if (d.secFilings?.length) {
          // Group filings by type
          const tenK = d.secFilings.filter(f => f.form === '10-K');
          const tenQ = d.secFilings.filter(f => f.form === '10-Q');
          const eightK = d.secFilings.filter(f => f.form === '8-K');
          
          const renderFilingCard = (filing, label, cssClass, others) => {
            if (!filing) return '';
            const hasOthers = others && others.length > 1;
            return `<div class="filing-card">
              <div class="form-type ${cssClass}">${label}</div>
              <div class="filed-date">Filed: ${formatDate(filing.filedDate)}</div>
              <div class="filing-links">
                <a href="${filing.reportUrl}" target="_blank">üìÑ View</a>
                <button class="summarize-btn" onclick="summarizeFiling('${filing.reportUrl}', '${filing.form}')">ü§ñ Summarize</button>
              </div>
              ${hasOthers ? `<details style="margin-top:8px;"><summary style="font-size:10px;color:#666;cursor:pointer;">+ ${others.length - 1} older</summary>
                <div style="margin-top:6px;font-size:11px;">
                  ${others.slice(1).map(f => `<a href="${f.reportUrl}" target="_blank" style="display:block;color:#60a5fa;margin:4px 0;">${formatDate(f.filedDate)}</a>`).join('')}
                </div>
              </details>` : ''}
            </div>`;
          };
          
          let filingsHtml = 
            renderFilingCard(tenK[0], '10-K Annual Report', 'annual', tenK) +
            renderFilingCard(tenQ[0], '10-Q Quarterly', 'quarterly', tenQ) +
            renderFilingCard(eightK[0], '8-K Current Report', 'current', eightK);
          
          // If no 10-K, show link to find on SEC EDGAR
          if (!tenK[0] && d.secEdgarUrl) {
            filingsHtml = `<div class="filing-card">
              <div class="form-type annual">10-K Annual Report</div>
              <div class="filed-date" style="color:#f59e0b;">Not in recent filings</div>
              <div class="filing-links">
                <a href="${d.secEdgarUrl}" target="_blank">üîç Find on SEC EDGAR</a>
              </div>
            </div>` + filingsHtml.replace(renderFilingCard(tenK[0], '10-K Annual Report', 'annual', tenK), '');
          }
          
          document.getElementById('detail-filings').innerHTML = filingsHtml;
        } else {
          document.getElementById('detail-filings').innerHTML = '<div style="color:#666">No SEC filings available</div>';
        }
      } catch(e) { console.error('Filings render error:', e); document.getElementById('detail-filings').innerHTML = '<div style="color:#f00">Error: '+e.message+'</div>'; }

      // Reset social sentiment section
      document.getElementById('social-sentiment').innerHTML = '<div style="color:#666;text-align:center;padding:10px;">Click to analyze social sentiment from credible financial sources</div>';
      document.getElementById('sentiment-btn').disabled = false;

      // Reset research section
      currentDetailSymbol = symbol;
      document.getElementById('research-content').innerHTML = '<div style="color:#666;text-align:center;padding:20px;">Click the button above to fetch real-time research from Perplexity AI</div>';
      document.getElementById('research-btn').disabled = false;
      document.getElementById('research-btn').classList.remove('loading');
      
      // Load competitors
      loadCompetitors(symbol);
    }

    async function loadCompetitors(symbol) {
      const content = document.getElementById('competitors-content');
      const sectorEl = document.getElementById('competitor-sector');
      
      content.innerHTML = '<div style="color:#666;text-align:center;padding:15px;"><span class="spinner" style="display:inline-block;width:14px;height:14px;border:2px solid #3b82f6;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-right:8px;vertical-align:middle;"></span>Loading competitors...</div>';
      
      try {
        const res = await fetch(`/api/competitors?symbol=${symbol}`);
        const data = await res.json();
        
        if (data.error || !data.competitors?.length) {
          content.innerHTML = '<div style="color:#666;text-align:center;padding:15px;">No competitor data available for this stock</div>';
          sectorEl.textContent = '--';
          return;
        }
        
        sectorEl.textContent = data.sector || '--';
        
        // Format helper
        const fmt = (n, decimals = 2) => n != null && !isNaN(n) ? n.toFixed(decimals) : '--';
        const fmtMktCap = (n) => {
          if (!n || isNaN(n)) return '--';
          if (n >= 1e12) return '$' + (n/1e12).toFixed(1) + 'T';
          if (n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
          if (n >= 1e6) return '$' + (n/1e6).toFixed(0) + 'M';
          return '$' + n.toLocaleString();
        };
        
        // Build comparison table
        const allStocks = [data.target, ...data.competitors].filter(Boolean);
        
        let html = `<table class="competitors-table">
          <thead>
            <tr>
              <th>Symbol</th>
              <th class="right">Price</th>
              <th class="right">Day</th>
              <th class="right">Mkt Cap</th>
              <th class="right">P/E</th>
              <th class="right">Yield</th>
              <th class="right">YTD</th>
            </tr>
          </thead>
          <tbody>`;
        
        allStocks.forEach(s => {
          const isUp = (s.changePercent || 0) >= 0;
          const ytdUp = (s.ytdReturn || 0) >= 0;
          const isTarget = s.isTarget;
          
          html += `<tr class="${isTarget ? 'target-row' : ''}">
            <td>
              <div class="symbol">${s.symbol}${isTarget ? ' ‚òÖ' : ''}</div>
              <div style="font-size:10px;color:#666;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${s.name || ''}</div>
            </td>
            <td class="right">$${fmt(s.price)}</td>
            <td class="right ${isUp ? 'up' : 'down'}">${isUp ? '+' : ''}${fmt(s.changePercent)}%</td>
            <td class="right">${fmtMktCap(s.marketCap)}</td>
            <td class="right">${fmt(s.pe, 1)}</td>
            <td class="right">${s.dividendYield ? fmt(s.dividendYield) + '%' : '--'}</td>
            <td class="right ${ytdUp ? 'up' : 'down'}">${s.ytdReturn != null ? (ytdUp ? '+' : '') + fmt(s.ytdReturn) + '%' : '--'}</td>
          </tr>`;
        });
        
        html += '</tbody></table>';
        content.innerHTML = html;
        
      } catch (err) {
        content.innerHTML = '<div style="color:#ef4444;text-align:center;padding:15px;">Error loading competitors: ' + err.message + '</div>';
      }
    }

    async function loadDeepResearch() {
      if (!currentDetailSymbol) return;

      const btn = document.getElementById('research-btn');
      const content = document.getElementById('research-content');

      btn.disabled = true;
      btn.classList.add('loading');
      content.innerHTML = '<div class="ai-loading"><span class="spinner"></span>Fetching real-time research via Perplexity...</div>';

      try {
        const res = await fetch('/api/research', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ symbol: currentDetailSymbol })
        });
        const data = await res.json();

        if (data.research) {
          // Convert markdown-style formatting to HTML
          let html = data.research
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n- /g, '</p><ul><li>')
            .replace(/\n\d+\. /g, '</p><ol><li>')
            .replace(/<\/li>\n/g, '</li><li>')
            .replace(/<li>$/gm, '</ul><p>')
            .replace(/^/, '<p>')
            .replace(/$/, '</p>');
          content.innerHTML = html;
        } else {
          content.innerHTML = '<div style="color:#ef4444;text-align:center;padding:20px;">Research unavailable. Try again later.</div>';
        }
      } catch (err) {
        content.innerHTML = '<div style="color:#ef4444;text-align:center;padding:20px;">Error fetching research: ' + err.message + '</div>';
      }

      btn.disabled = false;
      btn.classList.remove('loading');
    }

    async function loadSocialSentiment() {
      if (!currentDetailSymbol) return;
      
      const btn = document.getElementById('sentiment-btn');
      const content = document.getElementById('social-sentiment');
      
      btn.disabled = true;
      content.innerHTML = '<div class="ai-loading"><span class="spinner"></span>Analyzing sentiment from credible sources...</div>';
      
      try {
        const res = await fetch('/api/research', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            symbol: currentDetailSymbol,
            task: 'social_sentiment'
          })
        });
        const data = await res.json();
        
        if (data.research) {
          let html = data.research
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n- /g, '</p><ul><li>')
            .replace(/^/, '<p>')
            .replace(/$/, '</p>');
          content.innerHTML = `<div class="research-content" style="padding:0;max-height:300px;overflow-y:auto;">${html}</div>`;
        } else {
          content.innerHTML = '<div style="color:#666;text-align:center;padding:10px;">Could not analyze sentiment</div>';
        }
      } catch (err) {
        content.innerHTML = '<div style="color:#ef4444;text-align:center;padding:10px;">Error: ' + err.message + '</div>';
      }
      
      btn.disabled = false;
    }
    
    async function summarizeFiling(url, formType) {
      const filingsEl = document.getElementById('detail-filings');
      const originalContent = filingsEl.innerHTML;
      window.originalFilings = originalContent;

      // Show loading state with more detail
      filingsEl.innerHTML = `
        <div class="ai-loading">
          <span class="spinner"></span>
          <div style="margin-top:8px;">Analyzing ${formType} filing...</div>
          <div style="font-size:11px;color:#666;margin-top:4px;">Fetching document from SEC EDGAR, extracting content, running AI analysis</div>
        </div>`;

      try {
        const res = await fetch('/api/summarize-filing', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filingUrl: url,
            formType: formType,
            symbol: currentDetailSymbol
          })
        });
        const data = await res.json();

        if (data.error) {
          filingsEl.innerHTML = originalContent;
          alert('Error: ' + data.error);
          return;
        }

        if (data.summary) {
          // Convert markdown to HTML
          let html = data.summary
            // Headers
            .replace(/^## (.*$)/gm, '<h3 style="color:#60a5fa;margin:16px 0 8px;font-size:14px;">$1</h3>')
            .replace(/^### (.*$)/gm, '<h4 style="color:#888;margin:12px 0 6px;font-size:13px;">$1</h4>')
            // Bold
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // Bullet points
            .replace(/^- (.*$)/gm, '<li style="margin-left:16px;margin-bottom:4px;">$1</li>')
            // Paragraphs
            .replace(/\n\n/g, '</p><p style="margin:8px 0;line-height:1.5;">')
            .replace(/\n/g, '<br>');
          
          // Wrap in paragraph tags
          html = '<p style="margin:8px 0;line-height:1.5;">' + html + '</p>';
          
          // Clean up list items (wrap consecutive li's in ul)
          html = html.replace(/(<li[^>]*>.*?<\/li>\s*)+/g, '<ul style="margin:8px 0;padding-left:8px;">$&</ul>');
          
          const charInfo = data.filingLength ? `<span style="font-size:10px;color:#444;margin-left:8px;">(analyzed ${(data.filingLength/1000).toFixed(0)}k chars)</span>` : '';
          
          filingsEl.innerHTML = `
            <div style="margin-bottom:12px;display:flex;align-items:center;gap:8px;">
              <button onclick="document.getElementById('detail-filings').innerHTML = window.originalFilings" style="background:#2a2a4a;border:none;color:#888;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;">‚Üê Back to filings</button>
              <span style="font-size:12px;color:#60a5fa;">${formType} Analysis</span>
              ${charInfo}
            </div>
            <div class="research-content" style="padding:0;font-size:13px;color:#ccc;">${html}</div>
          `;
        } else {
          filingsEl.innerHTML = originalContent;
          alert('Could not summarize filing. The document may not be accessible or in an unsupported format.');
        }
      } catch (err) {
        filingsEl.innerHTML = originalContent;
        alert('Error: ' + err.message);
      }
    }

    function renderHoldings() {
      const sorted = sortData(currentStockData);

      // Update sort indicators
      document.querySelectorAll('.holdings-table th').forEach(th => {
        th.classList.remove('sorted', 'asc');
        if (th.dataset.sort === currentSort.key) {
          th.classList.add('sorted');
          if (currentSort.asc) th.classList.add('asc');
        }
      });

      document.getElementById('holdings-body').innerHTML = sorted.map(s => {
        const isUp = (s.change || 0) >= 0;
        const gainUp = s.gain >= 0;
        const exDivDays = s.exDivDays;
        const exDivSoon = exDivDays !== null && exDivDays >= 0 && exDivDays <= 14;

        return `
          <tr class="clickable" onclick="showStockDetail('${s.symbol}')">
            <td>
              <div class="symbol">${s.symbol}</div>
              <div class="company">${s.name || ''}</div>
            </td>
            <td class="right">${formatMoney(s.price)}</td>
            <td class="right ${isUp ? 'up' : 'down'}">${isUp ? '+' : ''}${s.change?.toFixed(2) || '0'}</td>
            <td class="right">${formatCompact(s.value)}</td>
            <td class="right ${gainUp ? 'up' : 'down'}">${formatCompact(s.gain)}</td>
            <td class="right ${gainUp ? 'up' : 'down'}">${formatPercent(s.gainPct)}</td>
            <td class="right ${(s.yield || 0) > 3 ? 'up' : ''}">${s.yield?.toFixed(2) || '--'}%</td>
            <td class="right hide-mobile">${exDivSoon ? '<span class="soon">'+exDivDays+'d</span>' : (s.exDivDate || '--')}</td>
            <td class="right hide-mobile">${formatCompact(s.annualDiv)}</td>
          </tr>
        `;
      }).join('');
    }

    async function loadPortfolio() {
      const member = PORTFOLIOS[currentMember];
      document.getElementById('member-label').textContent = member.name.toUpperCase() + "'S PORTFOLIO";
      showPortfolio();

      if (!member.holdings.length) {
        document.getElementById('portfolio-summary').innerHTML = '';
        document.getElementById('ai-summary-card').style.display = 'none';
        document.getElementById('alerts-row').style.display = 'none';
        document.getElementById('holdings-body').innerHTML = `
          <tr><td colspan="9" class="empty-state">
            <div class="icon">üì≠</div>
            <div>No holdings data yet</div>
            <div style="font-size:12px;margin-top:8px">Share a screenshot of this portfolio to add it</div>
          </td></tr>`;
        return;
      }

      // üöÄ IMMEDIATELY show skeleton loading UI
      renderSkeletons(member.holdings.length);
      
      // Show AI card with loading
      document.getElementById('ai-summary-card').style.display = 'block';
      document.getElementById('ai-summary-content').innerHTML = '<div class="ai-loading"><span class="spinner"></span>Analyzing your holdings...</div>';

      // üöÄ BATCH fetch all stocks in ONE request instead of N requests
      const symbols = member.holdings.map(h => h.symbol);
      const batchData = await batchFetchStocks(symbols);
      
      // Map the batch results to holdings
      const stockData = member.holdings.map((h, i) => {
        const d = batchData[i] || {};
        const value = h.shares * (d.price || 0);
        const cost = h.shares * h.costBasis;
        const gain = value - cost;
        const gainPct = cost > 0 ? (gain / cost) * 100 : 0;
        const annualDiv = h.shares * (d.dividendRate || 0);
        const exDivDays = daysUntil(d.exDividendDate);
        return {
          ...h,
          ...d,
          value,
          gain,
          gainPct,
          yield: d.dividendYield || 0,
          annualDiv,
          exDivDate: formatDate(d.exDividendDate),
          exDivDays
        };
      });

      currentStockData = stockData;

      // Calculate totals
      let totalValue = member.cash || 0;
      let totalCost = 0;
      let totalDayGain = 0;
      let totalAnnualDiv = 0;

      stockData.forEach(s => {
        totalValue += s.value;
        totalCost += s.shares * s.costBasis;
        totalDayGain += s.shares * (s.change || 0);
        totalAnnualDiv += s.annualDiv;
      });

      const totalGain = totalValue - totalCost - (member.cash || 0);
      const totalGainPct = totalCost > 0 ? (totalGain / totalCost) * 100 : 0;
      const dayGainPct = (totalValue - (member.cash || 0)) > 0 ? (totalDayGain / (totalValue - (member.cash || 0))) * 100 : 0;
      const avgYield = totalValue > 0 ? (totalAnnualDiv / totalValue) * 100 : 0;

      // Upcoming ex-div
      const upcomingExDiv = stockData.filter(s => s.exDivDays !== null && s.exDivDays >= 0 && s.exDivDays <= 30).sort((a,b) => a.exDivDays - b.exDivDays);

      // Update summary cards
      document.getElementById('portfolio-summary').innerHTML = `
        <div class="summary-card">
          <div class="label">Total Value</div>
          <div class="value">${formatMoney(totalValue)}</div>
          <div class="sub ${totalGain >= 0 ? 'up' : 'down'}">${totalGain >= 0 ? '+' : ''}${formatCompact(totalGain)} (${formatPercent(totalGainPct)})</div>
        </div>
        <div class="summary-card">
          <div class="label">Today</div>
          <div class="value ${totalDayGain >= 0 ? 'up' : 'down'}">${totalDayGain >= 0 ? '+' : ''}${formatMoney(totalDayGain)}</div>
          <div class="sub ${totalDayGain >= 0 ? 'up' : 'down'}">${formatPercent(dayGainPct)}</div>
        </div>
        <div class="summary-card">
          <div class="label">Annual Dividends</div>
          <div class="value up">${formatMoney(totalAnnualDiv)}</div>
          <div class="sub">${avgYield.toFixed(2)}% yield</div>
        </div>
        <div class="summary-card">
          <div class="label">Next Ex-Div</div>
          <div class="value ${upcomingExDiv.length ? 'warning' : ''}">${upcomingExDiv.length ? upcomingExDiv[0].symbol : '--'}</div>
          <div class="sub">${upcomingExDiv.length ? upcomingExDiv[0].exDivDays + ' days' : 'None upcoming'}</div>
        </div>
        <div class="summary-card">
          <div class="label">Cash</div>
          <div class="value">${formatMoney(member.cash)}</div>
          <div class="sub">&nbsp;</div>
        </div>
      `;

      // Update alerts row
      document.getElementById('alerts-row').style.display = 'grid';

      // Earnings alert - find stocks with earnings in next 14 days
      const earningsData = stockData.filter(s => {
        if (!s.earningsDate) return false;
        const days = daysUntil(s.earningsDate);
        return days !== null && days >= 0 && days <= 14;
      }).sort((a, b) => daysUntil(a.earningsDate) - daysUntil(b.earningsDate));

      if (earningsData.length) {
        const next = earningsData[0];
        const days = daysUntil(next.earningsDate);
        document.getElementById('earnings-detail').innerHTML = `<span class="warning">${next.symbol}</span> reports in ${days} day${days !== 1 ? 's' : ''}` +
          (earningsData.length > 1 ? ` <span style="color:#666">(+${earningsData.length - 1} more)</span>` : '');
      } else {
        document.getElementById('earnings-detail').textContent = 'No earnings in next 2 weeks';
      }

      // Concentration alert - check if any position is >20% of portfolio
      const sortedByValue = [...stockData].sort((a, b) => b.value - a.value);
      const topPosition = sortedByValue[0];
      const topPct = totalValue > 0 ? (topPosition.value / totalValue) * 100 : 0;
      const top3Pct = totalValue > 0 ? (sortedByValue.slice(0, 3).reduce((sum, s) => sum + s.value, 0) / totalValue) * 100 : 0;

      if (topPct > 25) {
        document.getElementById('concentration-detail').innerHTML = `<span class="danger">${topPosition.symbol} is ${topPct.toFixed(0)}%</span> of portfolio`;
      } else if (top3Pct > 60) {
        document.getElementById('concentration-detail').innerHTML = `Top 3 positions = <span class="warning">${top3Pct.toFixed(0)}%</span>`;
      } else {
        document.getElementById('concentration-detail').innerHTML = `<span class="success">Well diversified</span> (top position ${topPct.toFixed(0)}%)`;
      }

      // Dividend alert - next dividend payout
      if (upcomingExDiv.length) {
        const next = upcomingExDiv[0];
        const divPayment = next.shares * ((next.dividendRate || 0) / 4);
        document.getElementById('dividend-detail').innerHTML = `<span class="success">${next.symbol}</span> ex-div in ${next.exDivDays}d (~${formatCompact(divPayment)})`;
      } else {
        document.getElementById('dividend-detail').textContent = 'No ex-div dates in next 30 days';
      }

      // Render holdings table
      renderHoldings();

      document.getElementById('update-time').textContent = new Date().toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit'});

      // Generate AI summary
      generateAISummary(stockData);
    }

    async function generateAISummary(stockData) {
      try {
        const res = await fetch('/api/ai-summary', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ stocks: stockData.map(s => ({
            symbol: s.symbol,
            name: s.name,
            price: s.price,
            change: s.change,
            changePercent: s.changePercent,
            gain: s.gain,
            gainPct: s.gainPct,
            yield: s.yield,
            exDivDays: s.exDivDays,
            articles: s.articles?.slice(0, 3).map(a => a.attributes?.title),
            pressReleases: s.pressReleases?.slice(0, 2).map(p => p.attributes?.title)
          }))})
        });
        const data = await res.json();
        if (data.summary) {
          document.getElementById('ai-summary-content').innerHTML = data.summary;
        } else {
          document.getElementById('ai-summary-content').innerHTML = '<div style="color:#666">AI summary unavailable</div>';
        }
      } catch (e) {
        // Fallback to simple summary
        const highlights = [];
        const topGainer = [...stockData].sort((a,b) => b.gainPct - a.gainPct)[0];
        const topLoser = [...stockData].sort((a,b) => a.gainPct - b.gainPct)[0];
        const highYield = [...stockData].filter(s => s.yield > 3).sort((a,b) => b.yield - a.yield);
        const exDivSoon = stockData.filter(s => s.exDivDays !== null && s.exDivDays >= 0 && s.exDivDays <= 7);

        if (topGainer && topGainer.gainPct > 50) {
          highlights.push(`<div class="stock-insight"><span class="stock-ticker">${topGainer.symbol}</span> <span class="bullish">Top performer</span> with ${formatPercent(topGainer.gainPct)} gains.</div>`);
        }
        if (topLoser && topLoser.gainPct < -10) {
          highlights.push(`<div class="stock-insight"><span class="stock-ticker">${topLoser.symbol}</span> <span class="bearish">Underperforming</span> at ${formatPercent(topLoser.gainPct)}. Consider reviewing position.</div>`);
        }
        if (highYield.length) {
          highlights.push(`<div class="stock-insight"><span class="bullish">High yield positions:</span> ${highYield.map(s => s.symbol + ' (' + s.yield.toFixed(1) + '%)').join(', ')}</div>`);
        }
        if (exDivSoon.length) {
          highlights.push(`<div class="stock-insight"><span class="stock-ticker warning">‚ö†Ô∏è Ex-dividend coming:</span> ${exDivSoon.map(s => s.symbol + ' in ' + s.exDivDays + 'd').join(', ')}</div>`);
        }

        document.getElementById('ai-summary-content').innerHTML = highlights.length ? highlights.join('') : '<div style="color:#666">No significant alerts</div>';
      }
    }

    // Check if market is open (9:30am - 4pm ET, Mon-Fri)
    function isMarketOpen() {
      const now = new Date();
      const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
      const day = et.getDay();
      const hour = et.getHours();
      const min = et.getMinutes();
      const timeNum = hour * 100 + min;
      return day >= 1 && day <= 5 && timeNum >= 930 && timeNum <= 1600;
    }

    // Initialize
    buildTabs();
    setupSorting();
    loadPortfolio();

    // Auto-refresh disabled - manual refresh only
    // setInterval(() => {
    //   const interval = isMarketOpen() ? 60000 : 300000;
    //   loadPortfolio();
    // }, isMarketOpen() ? 60000 : 300000);

    // Show market status
    if (isMarketOpen()) {
      document.querySelector('.header .subtitle').textContent = 'Real-time ‚Ä¢ Market Open üü¢';
    }
  </script>
</body>
</html>
<!-- deploy trigger 1769884094 -->
