<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Dashboard - Steele Family</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f0f23; color: #e0e0e0; min-height: 100vh; }
    .header { background: linear-gradient(135deg, #1a1a3e 0%, #0f0f23 100%); padding: 20px 30px; border-bottom: 1px solid #2a2a4a; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .header h1 { font-size: 24px; font-weight: 600; color: #fff; }
    .header .subtitle { color: #888; font-size: 14px; margin-top: 4px; }
    .last-updated { color: #666; font-size: 12px; }
    .tabs { display: flex; gap: 4px; padding: 12px 30px; background: #12122a; border-bottom: 1px solid #2a2a4a; overflow-x: auto; }
    .tab { padding: 8px 14px; background: transparent; border: 1px solid #3a3a5a; border-radius: 8px; color: #888; cursor: pointer; white-space: nowrap; font-size: 12px; transition: all 0.2s; }
    .tab:hover { background: #1a1a3e; color: #fff; }
    .tab.active { background: #2563eb; border-color: #2563eb; color: #fff; }
    .tab.parent { border-color: #f59e0b44; }
    .tab.parent.active { background: #f59e0b; border-color: #f59e0b; }
    .main { padding: 30px; max-width: 1400px; margin: 0 auto; }
    
    /* Portfolio Summary */
    .portfolio-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .summary-card { background: #1a1a3e; border-radius: 12px; padding: 18px; border: 1px solid #2a2a4a; }
    .summary-card .label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 6px; }
    .summary-card .value { font-size: 28px; font-weight: 700; color: #fff; }
    .summary-card .value.up { color: #10b981; }
    .summary-card .value.down { color: #ef4444; }
    .summary-card .sub { font-size: 13px; color: #888; margin-top: 4px; }
    .summary-card .sub.up { color: #10b981; }
    .summary-card .sub.down { color: #ef4444; }
    
    /* Holdings Table */
    .holdings-card { background: #1a1a3e; border-radius: 12px; border: 1px solid #2a2a4a; overflow: hidden; margin-bottom: 24px; }
    .holdings-card h3 { font-size: 14px; padding: 16px 20px; border-bottom: 1px solid #2a2a4a; color: #fff; display: flex; align-items: center; gap: 8px; }
    .holdings-table { width: 100%; border-collapse: collapse; }
    .holdings-table th { text-align: left; padding: 12px 16px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #666; border-bottom: 1px solid #2a2a4a; background: #12122a; }
    .holdings-table th.right, .holdings-table td.right { text-align: right; }
    .holdings-table td { padding: 14px 16px; border-bottom: 1px solid #2a2a4a22; font-size: 14px; }
    .holdings-table tr:hover { background: #12122a; }
    .holdings-table tr:last-child td { border-bottom: none; }
    .holdings-table .symbol { font-weight: 600; color: #fff; }
    .holdings-table .company { font-size: 11px; color: #666; }
    .holdings-table .up { color: #10b981; }
    .holdings-table .down { color: #ef4444; }
    .holdings-table .muted { color: #666; }
    
    /* Stock Detail Modal */
    .stock-detail { display: none; }
    .stock-detail.active { display: block; }
    .back-btn { background: #2a2a4a; border: none; color: #888; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-bottom: 20px; }
    .back-btn:hover { background: #3a3a5a; color: #fff; }
    
    .stock-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; flex-wrap: wrap; gap: 20px; }
    .stock-info h2 { font-size: 28px; color: #fff; }
    .stock-info .company-name { color: #888; font-size: 14px; margin-top: 4px; }
    .price-box { text-align: right; }
    .price { font-size: 42px; font-weight: 700; }
    .price.up { color: #10b981; }
    .price.down { color: #ef4444; }
    .price-change { font-size: 16px; margin-top: 4px; }
    .price-change.up { color: #10b981; }
    .price-change.down { color: #ef4444; }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .card { background: #1a1a3e; border-radius: 12px; padding: 20px; border: 1px solid #2a2a4a; }
    .card h3 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
    .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .stat-item label { font-size: 11px; color: #666; display: block; margin-bottom: 2px; }
    .stat-item .value { font-size: 18px; font-weight: 600; color: #fff; }
    .stat-item .value.highlight { color: #10b981; }
    .stat-item .value.warning { color: #f59e0b; }
    
    .news-list { display: flex; flex-direction: column; gap: 10px; max-height: 280px; overflow-y: auto; }
    .news-item { padding-bottom: 10px; border-bottom: 1px solid #2a2a4a; }
    .news-item:last-child { border-bottom: none; }
    .news-item .date { font-size: 10px; color: #666; margin-bottom: 3px; }
    .news-item .title { font-size: 13px; color: #fff; line-height: 1.4; text-decoration: none; display: block; }
    .news-item .title:hover { color: #60a5fa; }
    .tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600; margin-left: 6px; }
    .tag.new { background: #10b98122; color: #10b981; }
    .tag.transcript { background: #7c3aed22; color: #a78bfa; }
    
    .clickable { cursor: pointer; }
    .member-label { font-size: 11px; color: #666; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
    .empty-state { text-align: center; padding: 60px 20px; color: #666; }
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
    
    @media (max-width: 768px) { 
      .main { padding: 15px; } 
      .tabs { padding: 10px 15px; } 
      .holdings-table { font-size: 12px; }
      .holdings-table th, .holdings-table td { padding: 10px 8px; }
      .summary-card .value { font-size: 22px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>üìä Steele Family Portfolio</h1>
      <div class="subtitle">Real-time Yahoo Finance + Seeking Alpha</div>
    </div>
    <div class="last-updated">Updated: <span id="update-time">--</span></div>
  </div>
  
  <div class="tabs" id="tabs"></div>
  
  <div class="main">
    <div class="member-label" id="member-label">PORTFOLIO</div>
    
    <!-- Portfolio View -->
    <div id="portfolio-view">
      <div class="portfolio-summary" id="portfolio-summary"></div>
      <div class="holdings-card">
        <h3>üíº Holdings</h3>
        <table class="holdings-table">
          <thead>
            <tr>
              <th>Symbol</th>
              <th class="right">Price</th>
              <th class="right">Change</th>
              <th class="right">Shares</th>
              <th class="right">Cost Basis</th>
              <th class="right">Value</th>
              <th class="right">Gain/Loss</th>
            </tr>
          </thead>
          <tbody id="holdings-body"></tbody>
        </table>
      </div>
    </div>
    
    <!-- Stock Detail View -->
    <div id="stock-detail" class="stock-detail">
      <button class="back-btn" onclick="showPortfolio()">‚Üê Back to Portfolio</button>
      <div class="stock-header">
        <div class="stock-info">
          <h2 id="detail-stock-name">Loading...</h2>
          <div class="company-name" id="detail-company-name">--</div>
        </div>
        <div class="price-box">
          <div class="price" id="detail-stock-price">--</div>
          <div class="price-change" id="detail-price-change">--</div>
        </div>
      </div>
      
      <div class="grid">
        <div class="card">
          <h3><span class="icon">üí∞</span> Position & Dividend</h3>
          <div class="stat-grid" id="detail-position"></div>
        </div>
        <div class="card">
          <h3><span class="icon">üìà</span> Key Stats</h3>
          <div class="stat-grid" id="detail-stats"></div>
        </div>
        <div class="card">
          <h3><span class="icon">üìã</span> Press Releases</h3>
          <div class="news-list" id="detail-press"><div style="color:#666">Loading...</div></div>
        </div>
        <div class="card">
          <h3><span class="icon">üéôÔ∏è</span> Earnings Calls</h3>
          <div class="news-list" id="detail-transcripts"><div style="color:#666">Loading...</div></div>
        </div>
        <div class="card" style="grid-column: span 2;">
          <h3><span class="icon">üì∞</span> Analysis</h3>
          <div class="news-list" id="detail-articles"><div style="color:#666">Loading...</div></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Portfolio data - shares and cost basis per share
    const PORTFOLIOS = {
      star: {
        name: 'Star',
        icon: '‚≠ê',
        holdings: [
          { symbol: 'META', shares: 130, costBasis: 217.2078 },
          { symbol: 'PLTR', shares: 490, costBasis: 15.9482 },
          { symbol: 'ET', shares: 4500, costBasis: 6.1146 },
          { symbol: 'AAPL', shares: 200, costBasis: 41.2121 },
          { symbol: 'GOOGL', shares: 125, costBasis: 98.6416 },
          { symbol: 'ARKB', shares: 1157, costBasis: 15.5836 },
          { symbol: 'BLOK', shares: 159, costBasis: 62.9177 },
          { symbol: 'DELL', shares: 51, costBasis: 125.0376 },
          { symbol: 'AGNC', shares: 199, costBasis: 10.1993 }
        ],
        cash: 193.56
      },
      peter: {
        name: 'Peter',
        icon: 'üë®‚Äçüíº',
        parent: true,
        holdings: [
          { symbol: 'NVDA', shares: 700, costBasis: 5.1503 },
          { symbol: 'AMZN', shares: 350, costBasis: 154.6477 },
          { symbol: 'GOOGL', shares: 237, costBasis: 172.5978 },
          { symbol: 'AAPL', shares: 200, costBasis: 28.2235 },
          { symbol: 'TSLA', shares: 119, costBasis: 301.0092 },
          { symbol: 'ARKB', shares: 1038, costBasis: 17.879 },
          { symbol: 'JPM', shares: 100, costBasis: 99.2174 },
          { symbol: 'META', shares: 35, costBasis: 111.8417 },
          { symbol: 'THNQ', shares: 299, costBasis: 52.4067 },
          { symbol: 'BTO', shares: 315, costBasis: 24.3786 },
          { symbol: 'XOVR', shares: 549, costBasis: 17.3108 },
          { symbol: 'DELL', shares: 57, costBasis: 125.00 }
        ],
        cash: 13.39
      },
      sherry: { name: 'Sherry', icon: 'üë©‚Äçüíº', parent: true, holdings: [], cash: 0 },
      sky: { name: 'Sky', icon: 'üåü', holdings: [], cash: 0 },
      jet: { name: 'Jet', icon: '‚úàÔ∏è', holdings: [], cash: 0 },
      everly: { name: 'Everly', icon: 'üéÄ', holdings: [], cash: 0 },
      leo: { name: 'Leo', icon: 'ü¶Å', holdings: [], cash: 0 },
      autumn: { name: 'Autumn', icon: 'üçÇ', holdings: [], cash: 0 },
      ace: { name: 'Ace', icon: 'üÉè', holdings: [], cash: 0 },
      stryker: { name: 'Stryker', icon: '‚ö°', holdings: [], cash: 0 },
      maverick: { name: 'Maverick', icon: 'üî•', holdings: [], cash: 0 },
      cannon: { name: 'Cannon', icon: 'üí•', holdings: [], cash: 0 },
      missile: { name: 'Missile', icon: 'üöÄ', holdings: [], cash: 0 }
    };
    
    let currentMember = 'star';
    let stockCache = {};
    
    function formatMoney(n) {
      if (n === undefined || n === null) return '--';
      return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    function formatPercent(n) {
      if (n === undefined || n === null) return '--';
      return (n >= 0 ? '+' : '') + n.toFixed(2) + '%';
    }
    
    function timeAgo(dateStr) {
      if (!dateStr) return '--';
      const d = new Date(dateStr), now = new Date();
      const hrs = Math.floor((now - d) / 36e5);
      if (hrs < 1) return 'Just now';
      if (hrs < 24) return hrs + 'h ago';
      const days = Math.floor(hrs / 24);
      return days === 1 ? 'Yesterday' : days < 7 ? days + 'd ago' : d.toLocaleDateString('en-US', {month:'short',day:'numeric'});
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '--';
      return new Date(dateStr).toLocaleDateString('en-US', {month:'short',day:'numeric'});
    }
    
    // Build tabs
    function buildTabs() {
      const tabsEl = document.getElementById('tabs');
      tabsEl.innerHTML = Object.entries(PORTFOLIOS).map(([key, p]) => 
        `<div class="tab ${p.parent ? 'parent' : ''} ${key === currentMember ? 'active' : ''}" data-member="${key}">${p.icon} ${p.name}</div>`
      ).join('');
      
      tabsEl.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        currentMember = t.dataset.member;
        loadPortfolio();
      }));
    }
    
    async function fetchStock(symbol) {
      if (stockCache[symbol] && (Date.now() - stockCache[symbol].fetchedAt) < 60000) {
        return stockCache[symbol].data;
      }
      const res = await fetch('/api/stock/' + symbol);
      const data = await res.json();
      stockCache[symbol] = { data, fetchedAt: Date.now() };
      return data;
    }
    
    function showPortfolio() {
      document.getElementById('portfolio-view').style.display = 'block';
      document.getElementById('stock-detail').classList.remove('active');
    }
    
    async function showStockDetail(symbol) {
      const member = PORTFOLIOS[currentMember];
      const holding = member.holdings.find(h => h.symbol === symbol);
      if (!holding) return;
      
      document.getElementById('portfolio-view').style.display = 'none';
      document.getElementById('stock-detail').classList.add('active');
      
      const d = await fetchStock(symbol);
      const shares = holding.shares;
      const costBasis = holding.costBasis;
      const totalCost = shares * costBasis;
      const currentValue = shares * (d.price || 0);
      const gain = currentValue - totalCost;
      const gainPct = totalCost > 0 ? (gain / totalCost) * 100 : 0;
      
      const isUp = d.change >= 0;
      document.getElementById('detail-stock-name').textContent = symbol + ' - ' + (d.name || '');
      document.getElementById('detail-company-name').textContent = (d.exchange || '') + ' ¬∑ ' + (d.analystRating || '');
      document.getElementById('detail-stock-price').textContent = formatMoney(d.price);
      document.getElementById('detail-stock-price').className = 'price ' + (isUp ? 'up' : 'down');
      document.getElementById('detail-price-change').textContent = (isUp ? '+' : '') + (d.change?.toFixed(2) || '0') + ' (' + (d.changePercent?.toFixed(2) || '0') + '%)';
      document.getElementById('detail-price-change').className = 'price-change ' + (isUp ? 'up' : 'down');
      
      const qDiv = (d.dividendRate || 0) / 4;
      const qPay = qDiv * shares;
      const aPay = (d.dividendRate || 0) * shares;
      
      document.getElementById('detail-position').innerHTML = 
        `<div class="stat-item"><label>Shares</label><div class="value">${shares.toLocaleString()}</div></div>` +
        `<div class="stat-item"><label>Cost Basis</label><div class="value">${formatMoney(costBasis)}</div></div>` +
        `<div class="stat-item"><label>Current Value</label><div class="value highlight">${formatMoney(currentValue)}</div></div>` +
        `<div class="stat-item"><label>Total Gain</label><div class="value ${gain >= 0 ? 'highlight' : 'warning'}">${formatMoney(gain)} (${formatPercent(gainPct)})</div></div>` +
        `<div class="stat-item"><label>Dividend Yield</label><div class="value">${(d.dividendYield?.toFixed(2) || '--')}%</div></div>` +
        `<div class="stat-item"><label>Annual Dividend</label><div class="value highlight">${formatMoney(aPay)}</div></div>`;
      
      document.getElementById('detail-stats').innerHTML = 
        `<div class="stat-item"><label>Day Range</label><div class="value">${formatMoney(d.dayLow)} - ${formatMoney(d.dayHigh)}</div></div>` +
        `<div class="stat-item"><label>52W Range</label><div class="value">${formatMoney(d.fiftyTwoWeekLow)} - ${formatMoney(d.fiftyTwoWeekHigh)}</div></div>` +
        `<div class="stat-item"><label>Volume</label><div class="value">${((d.volume/1e6)?.toFixed(1)||'--')}M</div></div>` +
        `<div class="stat-item"><label>Market Cap</label><div class="value">$${((d.marketCap/1e9)?.toFixed(1)||'--')}B</div></div>` +
        `<div class="stat-item"><label>Next Earnings</label><div class="value warning">${formatDate(d.earningsDate)}</div></div>` +
        `<div class="stat-item"><label>Pay Date</label><div class="value">${formatDate(d.dividendDate)}</div></div>`;
      
      if (d.pressReleases?.length) {
        document.getElementById('detail-press').innerHTML = d.pressReleases.map(p => {
          const isNew = (new Date() - new Date(p.attributes?.publishOn)) < 864e5;
          return `<div class="news-item"><div class="date">${timeAgo(p.attributes?.publishOn)}${isNew?'<span class="tag new">NEW</span>':''}</div><a class="title" href="https://seekingalpha.com${p.links?.self||''}" target="_blank">${p.attributes?.title||''}</a></div>`;
        }).join('') || '<div style="color:#666">No recent releases</div>';
      } else {
        document.getElementById('detail-press').innerHTML = '<div style="color:#666">No recent releases</div>';
      }
      
      if (d.transcripts?.length) {
        document.getElementById('detail-transcripts').innerHTML = d.transcripts.map(t => 
          `<div class="news-item"><div class="date">${timeAgo(t.attributes?.publishOn)}<span class="tag transcript">CALL</span></div><a class="title" href="https://seekingalpha.com${t.links?.self||''}" target="_blank">${t.attributes?.title||''}</a></div>`
        ).join('');
      } else {
        document.getElementById('detail-transcripts').innerHTML = '<div style="color:#666">No recent calls</div>';
      }
      
      if (d.articles?.length) {
        document.getElementById('detail-articles').innerHTML = d.articles.map(a => 
          `<div class="news-item"><div class="date">${timeAgo(a.attributes?.publishOn)}</div><a class="title" href="https://seekingalpha.com${a.links?.self||''}" target="_blank">${a.attributes?.title||''}</a></div>`
        ).join('');
      } else {
        document.getElementById('detail-articles').innerHTML = '<div style="color:#666">No recent analysis</div>';
      }
    }
    
    async function loadPortfolio() {
      const member = PORTFOLIOS[currentMember];
      document.getElementById('member-label').textContent = member.name.toUpperCase() + "'S PORTFOLIO";
      showPortfolio();
      
      if (!member.holdings.length) {
        document.getElementById('portfolio-summary').innerHTML = '';
        document.getElementById('holdings-body').innerHTML = `
          <tr><td colspan="7" class="empty-state">
            <div class="icon">üì≠</div>
            <div>No holdings data yet</div>
            <div style="font-size:12px;margin-top:8px">Share a screenshot of this portfolio to add it</div>
          </td></tr>`;
        return;
      }
      
      // Fetch all stock data
      const stockData = await Promise.all(
        member.holdings.map(h => fetchStock(h.symbol).then(d => ({ ...h, ...d })))
      );
      
      // Calculate totals
      let totalValue = member.cash || 0;
      let totalCost = 0;
      let totalDayGain = 0;
      let totalAnnualDiv = 0;
      
      stockData.forEach(s => {
        const value = s.shares * (s.price || 0);
        const cost = s.shares * s.costBasis;
        const dayGain = s.shares * (s.change || 0);
        const annualDiv = s.shares * (s.dividendRate || 0);
        
        totalValue += value;
        totalCost += cost;
        totalDayGain += dayGain;
        totalAnnualDiv += annualDiv;
      });
      
      const totalGain = totalValue - totalCost - (member.cash || 0);
      const totalGainPct = totalCost > 0 ? (totalGain / totalCost) * 100 : 0;
      const dayGainPct = (totalValue - (member.cash || 0)) > 0 ? (totalDayGain / (totalValue - (member.cash || 0))) * 100 : 0;
      
      // Update summary cards
      document.getElementById('portfolio-summary').innerHTML = `
        <div class="summary-card">
          <div class="label">Total Value</div>
          <div class="value">${formatMoney(totalValue)}</div>
          <div class="sub ${totalGain >= 0 ? 'up' : 'down'}">${formatMoney(totalGain)} (${formatPercent(totalGainPct)})</div>
        </div>
        <div class="summary-card">
          <div class="label">Today's Change</div>
          <div class="value ${totalDayGain >= 0 ? 'up' : 'down'}">${totalDayGain >= 0 ? '+' : ''}${formatMoney(totalDayGain)}</div>
          <div class="sub ${totalDayGain >= 0 ? 'up' : 'down'}">${formatPercent(dayGainPct)}</div>
        </div>
        <div class="summary-card">
          <div class="label">Annual Dividends</div>
          <div class="value up">${formatMoney(totalAnnualDiv)}</div>
          <div class="sub">${formatMoney(totalAnnualDiv / 4)}/quarter</div>
        </div>
        <div class="summary-card">
          <div class="label">Cash</div>
          <div class="value">${formatMoney(member.cash)}</div>
          <div class="sub">&nbsp;</div>
        </div>
      `;
      
      // Update holdings table
      document.getElementById('holdings-body').innerHTML = stockData.map(s => {
        const value = s.shares * (s.price || 0);
        const cost = s.shares * s.costBasis;
        const gain = value - cost;
        const gainPct = cost > 0 ? (gain / cost) * 100 : 0;
        const isUp = (s.change || 0) >= 0;
        const gainUp = gain >= 0;
        
        return `
          <tr class="clickable" onclick="showStockDetail('${s.symbol}')">
            <td>
              <div class="symbol">${s.symbol}</div>
              <div class="company">${s.name || ''}</div>
            </td>
            <td class="right">${formatMoney(s.price)}</td>
            <td class="right ${isUp ? 'up' : 'down'}">${isUp ? '+' : ''}${s.change?.toFixed(2) || '0'} (${s.changePercent?.toFixed(1) || '0'}%)</td>
            <td class="right">${s.shares.toLocaleString()}</td>
            <td class="right muted">${formatMoney(s.costBasis)}</td>
            <td class="right">${formatMoney(value)}</td>
            <td class="right ${gainUp ? 'up' : 'down'}">${formatMoney(gain)}<br><span style="font-size:11px">${formatPercent(gainPct)}</span></td>
          </tr>
        `;
      }).join('');
      
      document.getElementById('update-time').textContent = new Date().toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit'});
    }
    
    // Initialize
    buildTabs();
    loadPortfolio();
    setInterval(loadPortfolio, 60000);
  </script>
</body>
</html>
